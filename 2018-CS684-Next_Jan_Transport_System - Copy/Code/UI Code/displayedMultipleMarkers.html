<!--

Team Id: Next Jan Transport System 
Author List: Abhijit Divekar, AjayKumar Maurya, Punit Jain.
Filename: displayedMultipleMarker.html
Theme: CS 684 Project 
JavaScript Functions: initMap(), readItem(), formatLatLng(), ObtainAddress(), ETAandDisplay(), deleteMarkers(), deleteInfoWindows()
Global Vaiables: destinationIcon, originIcon

This File Accesses Data from DynamoDB of Buses specified in BusIDs Array. It then Queries Google Maps API for Estimated Time Arrival. 
It also displays the current Location and ETA in a tabular form indexed by BusIDS. 
-->

<html>
<head>
<style>
      #map {
        height: 100%;
      }
#floating-panel {
        position: absolute;
        top: 50px;
        left: 15%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
#floating-panel {
        position: absolute;
        top: 50px;
        left: 15%;
        margin-left: -180px;
        width: 350px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
table, th, td {
    border: 1px solid black;
}
</style>
<body>
<div id="floating-panel">
<table style="width:100%">
  <tr>
    <th>Bus ID</th>
    <th>Locations</th> 
    <th>Estimated Time of Arrival</th>
  </tr>
  <tr>
    <td id="BusID0"></td>
    <td id="Location0"></td> 
    <td id="ETA0"></td>
  </tr>
  <tr>
    <td id="BusID1"></td>
    <td id="Location1"></td> 
    <td id="ETA1"></td>
  </tr>
  <tr>
    <td id="BusID2"></td>
    <td id="Location2"></td> 
    <td id="ETA2"></td>
  </tr>  
  <tr>
    <td id="BusID3"></td>
    <td id="Location3"></td> 
    <td id="ETA3"></td>
  </tr>  
</table>
</div>
<div id="output"></div>
</div>
<div id="map"></div>
</body>




<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>

<script>
var destinationIcon = 'https://chart.googleapis.com/chart?' +
	'chst=d_map_pin_letter&chld=D|FF0000|000000';
var originIcon = 'https://chart.googleapis.com/chart?' +
	'chst=d_map_pin_letter&chld=O|FFFF00|000000';
//If Destination is to be changed, it has to be done at two places. One at Marker other at ETAandDisplay function.

AWS.config.update({
  region: "us-west-2",
  // accessKeyId default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  accessKeyId: 'AKIAJ2QUGFT76OVEY7IQ',
  // secretAccessKey default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  secretAccessKey: 'zJqu57F6EzaR/exH4jwkFn17MRuUEna0gDE81I9l'
});

var docClient = new AWS.DynamoDB.DocumentClient();
function initMap() {
	var map = new google.maps.Map(document.getElementById('map'), {
	  zoom: 14,
	  center: {lat: 19.1334, lng: 72.9133}
	});
	var destMarker = new google.maps.Marker({
		map: map,
		position: {lat:19.124164, lng:72.913683},
		icon : destinationIcon 
		});
	
	
	console.log("Google Maps loaded");
	setInterval( function() { readItem(map); }, 10000 );
//	readItem(map);
}

function readItem(map) {
BusIDs = ["602","881","882","883"];
for (i =0 ; i < BusIDs.length ; i++){
		var DataAllBuses = new Object()
		var BusData = new Object()
				var params = {
					TableName : "BusData3",
					KeyConditionExpression: "#id = :ddd",
					ExpressionAttributeNames:{
						"#id": "BusID"
					},
					ExpressionAttributeValues: {
						":ddd":BusIDs[i]
					}
				};
			docClient.query(params, function(err, data) {
				if (err) {
				 //   document.getElementById('textarea').innerHTML = "Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2);
					console.log("Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2));
					alert("Unable to connect to Database");
				} else {
					//document.getElementById('textarea').innerHTML = "GetItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
					JSON.stringify(data, undefined, 2);
					console.log("Query Fetched");
					BusData["BusID"] = data.Items[0].payload.BusID;
					BusData["LatLng"] = {"lat": data.Items[0].payload.Latitude, "lng": data.Items[0].payload.Longitude}
					DataAllBuses[data.Items[0].payload.BusID] = {"lat": data.Items[0].payload.Latitude, "lng": data.Items[0].payload.Longitude};
					//alert(JSON.stringify(DataAllBuses));
					//document.getElementById("BusID").innerHTML = data.Items[0].payload.BusID; 
					console.log("BusData stored in object");
					if (Object.keys(DataAllBuses).length === 4 )
					{console.log("sending DataAllBuses for formatting");
					//alert(JSON.stringify(DataAllBuses));
					formatLatLng(DataAllBuses,map);	
					}
					else{
					console.log("Do nothing");
					}


				}
			});
	}
}

function formatLatLng(DataAllBuses,map){
var inputs =new Object()
for (var property in DataAllBuses){ 
//alert(BusData.BusID);
//alert(BusData.LatLng.lat);
//alert(BusData.LatLng.lng);
		
		var temp1 = DataAllBuses[property].lat.slice(0,2);
		temp1 = parseFloat(temp1);
		var temp2 = DataAllBuses[property].lat.slice(2,10);
		temp2 = parseFloat(temp2);	
		temp2 =  (temp2/60.0);
		var temp5 = temp1+ temp2;
		temp5 = temp5.toFixed(5);
		//alert(temp5);

		var temp3 = DataAllBuses[property].lng.slice(0,3);	
		temp3 = parseFloat(temp3);	
		var temp4 = DataAllBuses[property].lng.slice(3,11);
		temp4 = parseFloat(temp4);
		temp4 =  (temp4/60.0);
		var temp6 = temp3+ temp4;
		temp6 = temp6.toFixed(5);
		inputs[property] = temp5.toString()+","+temp6.toString();
		//alert(temp6);
		//alert(JSON.stringify(inputs));
		if (Object.keys(inputs).length === 4 )
		{console.log("Formatting Done and sending data to ETA");
		//alert(JSON.stringify(inputs));
		ETAandDisplay(inputs,map);	
		}
		else{
		console.log("Do nothing");
		}
	}
}

function ETAandDisplay(inputs,map){
console.log("calculating ETA")
//alert(JSON.stringify(Addresses));
var Dest ={lat:19.124164, lng:72.913683}
var all_origins = [];
var all_dests = [];
var all_busIDs = [];
for (var property in inputs){
all_busIDs.push(property);
var latlngStr = inputs[property].split(',', 2);
var latlng = {lat: parseFloat(latlngStr[0]), lng: parseFloat(latlngStr[1])};
all_origins.push(latlng);
all_dests.push(Dest);
//alert("Here:   "+all_busIDs);
}
var geocoder =new google.maps.Geocoder;
var service = new google.maps.DistanceMatrixService;
service.getDistanceMatrix({
	origins: all_origins,
	destinations: all_dests,
	travelMode: 'DRIVING'
	}, function (response, status){
		if (status !== 'OK'){alert('DistanceMatrixService Failed: ' + status);
							}
		else{
			var markersArray =[];
			var InfoWindowArray=[];
            var originList = response.originAddresses;
            var destinationList = response.destinationAddresses;
        //    var outputDiv = document.getElementById('output');
        //    outputDiv.innerHTML = '';
            deleteMarkers(markersArray);
			deleteInfoWindows(InfoWindowArray);
			//alert(originList.length);
			//alert(destinationList.length);
			var LocationsArray=[];
			
			for (var i = 0; i < originList.length; i++) {
			var finalResults = response.rows[i].elements;
			//alert(finalResults[i].duration.text);
			document.getElementById('ETA'+i).innerHTML = finalResults[i].duration.text;
			var k = 0;
			geocoder.geocode({'address': originList[i]},function(results,status){
			if (status == 'OK'){
				//alert("HERE:"+results[0].geometry.location);
				markersArray.push(new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                icon: originIcon
                  }));
				var masterMarker = markersArray[markersArray.length -1];
				var infowindow = null; 
				infowindow = new google.maps.InfoWindow({
				content: "holding..."
				});
				
				google.maps.event.addListener(masterMarker, 'click', function () {
				infowindow.setContent(results[0].formatted_address);
				infowindow.open(map, this);
				});

				LocationsArray.push(results[0].formatted_address)
				document.getElementById('Location'+k).innerHTML = results[0].formatted_address;
				k++;
				  
			}
			else{alert("Geocoder Failed:"+status);
			}
			});
			//alert("came here");
			
			for (var j=0; j < finalResults.length; j++){
			document.getElementById('BusID'+j).innerHTML = all_busIDs[j];
//			document.getElementById('Location'+j).innerHTML = LocationsArray[j];
/*			if (finalResults[j] == 'undefined'){
			console.log("Do nothing");
			}
			else{
			alert(JSON.stringify(finalResults[j]));
			alert('ETA'+j);
			document.getElementById('ETA'+j).innerHTML = finalResults[j].duration.text;}			
*/			
			//document.getElementById('Location'+j).innerHTML = LocationsArray[j];
			
			}
			
            
}			
		}			
		}
);


}"ETA Display Ends here"
function deleteMarkers(markersArray) {
for (var i = 0; i < markersArray.length; i++) {
  markersArray[i].setMap(null);
}
markersArray = [];
}

function deleteInfoWindows(InfoWindowArray) {
for (var i = 0; i < InfoWindowArray.length; i++) {
  InfoWindowArray[i].setMap(null);
}
InfoWindowArray = [];
}

</script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQYQgMV5T_0ky48LhJuYkMeJflOSr1qGk&callback=initMap">
    </script>
</head>


</html>